---
title: "Determinist scores"
output: html_document
---

```{r setup, include=FALSE}

dir_data <- "D:/HOME/ekamir/scoring_medscope/data/season" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure"

library(dplyr)
library(tidyverse)
library(plyr)
library(easyVerification)
library(verification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
library(readr)

```
## Parameters 

```{r }

# temporal agregation
temp <- 1:6 

# chosen quantile
kantile <- "quint" # ter or quint

# bootstrap and cores
no_core <- 6
nboot <- 50

if (kantile=="quint"){
  proba = 1:4/5; events = 5
} else { proba = 1:2/3; events = 3}

```

                                            ### GRIDDED ###
                                            
                                            
## Gridded scores

Scores computed for each grid separately.
Indicators are assessed on a 28 days time window and over the whole season

```{r}

tictoc::tic()

acc <- vector()
msess <- vector()

for (ind in c(2,3,4,8)){

  cl <- makeCluster(no_core)
  registerDoParallel(cl)

  foreach(b=1:nboot, .packages=c('easyVerification', 's2dverification')) %dopar%  { # loop on bootstrap samples
  #Spearman <- easyVerification:::EnsCorr
    
    nom_ref <- paste0(indic[ind],b,"_ref.RData")
    nom_prev <- paste0(indic[ind],b,"_prev.RData")
    nom_clim <- paste0(indic[ind],b,"_clim.RData")
    nom_an_prev <- paste0(indic[ind],b,"_anomaly_prev.RData")
    nom_an_obs <- paste0(indic[ind],b,"_anomaly_obs.RData")
    
    load(file = file.path(dir_data, "extract", nom_ref))
    load(file = file.path(dir_data, "extract", nom_prev))
    load(file = file.path(dir_data, "extract", nom_clim))
    load(file = file.path(dir_data, "extract", nom_an_prev))
    load(file = file.path(dir_data, "extract", nom_an_obs))
    
    ngrids <- dim(array_obs)[1]
    
    # BE CAREFUL ON AGREGATION METHOD!!!!
    det_seas <- array(NA, dim = c(ngrids,3))
    prev_seas <- apply(array_prev[,,,temp], c(1,2,3), sum) #### aggregation method to be changed!!
    clim_seas <- apply(array_clim[,,,temp], c(1,2,3), sum)
    ref_seas <- apply(array_obs[,,temp], c(1,2), sum)
  
      # MSESS #
    msess <- veriApply("EnsMsess", fcst=prev_seas, fcst.ref=clim_seas, obs=ref_seas, parallel = TRUE)
          
      # ACC #
    acc <- veriApply("EnsCorr", fcst=prev_anomaly, obs=obs_anomaly, parallel = TRUE)
    
    score_det <- array(c(msess, acc), dim=c(ngrids,2))
    
    nom_det <- paste0(indic[ind], b,"scoredet_grid.RData")
  
    save(score_det, file = file.path(dir_data, "score", nom_det))
  

}
stopCluster(cl)

}
tictoc::toc() 



```

  
                                            ### BOX SCORES ###
                                            
                                            
## Aggregated scores

Scores computed for each grid separately.
Indicators are assessed on a 28 days time window and over the whole season

```{r}

coeff <- vector()
seas_ps <- matrix(ncol = 2, nrow = 6)
load(file = file.path(dir_data, "extract", "lat.RData"))

for (ind in c(2,3,4,8)){
  boot_det <- list()

  for(b in 1:nboot)   {
    
    # loading gridded scores
  
    nom_prevseas <- paste0(indic[ind], b,"scoredetseas_grid_prev.RData")
    load(file = file.path(dir_data, "score", nom_prevseas))
    ngrids <- dim(score_det)[1]

    val_prevseas <- list()
  
    for (i in 1:ngrids){
      val_prevseas[[i]] <- score_det[i,]*cos(pi*lat[i]/180)
      coeff[i] <- cos(pi*lat[i]/180)
      # removing NAs
      if (length(which(is.na(score_det[i,])))>0){
        coeff[i] <- NA
        val_prevseas[[i]] <- rep(NA,2)
      }
    }
  
    det_boot[[b]] <- apply(array(unlist(val_prevseas) , c(2,ngrids)), 1, sum, na.rm = T)/sum(coeff, na.rm = T)
  }
  
    nom_bootseas <- paste0(indic[ind], "scoredet_boot.csv")
    save(det_boot, file = file.path(dir_data, "score", nom_bootseas))
    
    det_meanboot <- apply(array(unlist(boot_seas) , c(2,nboot)), 1, mean, na.rm=T)
    nom_meanseas <- paste0(indic[ind], "detbox_meanboot.csv")
    write_csv(as.data.frame(det_meanboot), file.path(dir_data, "score", nom_meanseas))

}

```


## Box score significance test

Wilcoxon test with H0: MSESS non supérieure à 0 + ACC non supérieur à 0.3

```{r}
ind <- 2

   # season
  nom_bootseas <- paste0(indic[ind], "scoredet_boot.csv")
  load(file = file.path(dir_data, "score", nom_bootseas))

  boxboot <- array(unlist(det_boot) , c(2,nboot))
  
  wilcox.test(boxboot[1,], mu = 0, alternative = "greater", conf.level = 0.95, na.action = na.omit)$p.value # msess
  wilcox.test(boxboot[2,], mu = 0.3, alternative = "greater", conf.level = 0.95, na.action = na.omit)$p.value # acc


```
