---
title: "Determinist scores"
output: html_document
---

```{r setup, include=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/season_trial2" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure"
library(dplyr)
library(tidyverse)
library(plyr)
library(easyVerification)
library(verification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
library(readr)
no_core <- 6

```
## Computing grid scores and saving them in arrays called "det_"

```{r setup, include=FALSE}
#
tictoc::tic()
acc_prev <- vector()
acc_clim <- vector()
msess <- vector()

for (ind in 1:8){
   # require(doSNOW)
   # registerDoSNOW(makeCluster(2, type = "SOCK"))

  # , .verbose = T
cl <- makeCluster(no_core)
registerDoParallel(cl)
#registerDoSNOW(cl)

foreach(b=1:500, .packages=c('easyVerification', 's2dverification')) %dopar%  { # loop on bootstrap samples
#Spearman <- easyVerification:::EnsCorr
  
  nom_ref <- paste0(indic[ind],b,"_ref.RData")
  nom_prev <- paste0(indic[ind],b,"_prev.RData")
  nom_clim <- paste0(indic[ind],b,"_clim.RData")
  nom_an_prev <- paste0(indic[ind],b,"_anomaly_prev.RData")
  nom_an_clim <- paste0(indic[ind],b,"_anomaly_clim.RData")
  nom_an_obs <- paste0(indic[ind],b,"_anomaly_obs.RData")
  
  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))
  load(file = file.path(dir_data, "extract", nom_clim))
  load(file = file.path(dir_data, "extract", nom_an_prev))
  load(file = file.path(dir_data, "extract", nom_an_clim))
  load(file = file.path(dir_data, "extract", nom_an_obs))
  
  # ensemble mean 
  prev_mean <- apply(array_prev, c(1,2,4), mean)
  clim_mean <- apply(array_clim, c(1,2,4), mean)

  ### Score computing: We compute bias, and cross validated rmse and correlation coefficient.
  
      ### MONTHLY ###
  
  det_month <- array(NA, dim = c(ngrids,3,ndimT))

  for (t in 1:ndimT){ 
    
    # MSESS
    
  msess <- veriApply("EnsMsess", fcst=t(prev_mean[,,t]), fcst.ref=t(clim_mean[,,t]), obs=t(array_obs[,,t]), parallel = TRUE)

   # ACC #
    
      # Pearson for continued indicators
    #if (ind!=3 & ind!=4 & ind!=5) { 
      # ref vs prev
    acc_prev <- veriApply("EnsCorr", fcst=prev_anomaly[,,,t], obs=obs_anomaly[,,t], parallel = TRUE)
      # ref vs clim
    acc_clim <- veriApply("EnsCorr", fcst=clim_anomaly[,,,t], obs=obs_anomaly[,,t], parallel = TRUE)
    
    # } else { # Spearman for ordinal indicators
    #   Spearman <- s2dverification:::.Corr
    #   # ref vs prev
    # acc_prev <- veriApply("Corr", fcst=clim_anomaly[,,,t], obs=clim_anomaly[,,,t],  posloop = 2,)$corr
    #   # ref vs clim
    # acc_clim <- veriApply("Corr", fcst=clim_anomaly[,,,t], obs=obs_anomaly[,,t], parallel = TRUE)$corr
    #   
    # }
  
  det_month[,,t] <- array(c(msess, acc_prev, acc_clim), dim=c(ngrids,3))

  }
  
      ### SEASONAL ###
  
  det_seas <- array(NA, dim = c(ngrids,3))

  prev_seas <- apply(array_prev, c(1,2,3), sum)
  clim_seas <- apply(array_clim, c(1,2,3), sum)
  ref_seas <- apply(array_obs, c(1,2), sum)
  
  prev_seas_mean <- apply(prev_seas, c(1,2), mean)
  clim_seas_mean <- apply(clim_seas, c(1,2), mean)
  
  anoprev_seas <- apply(prev_anomaly, c(1,2,3), sum)
  anoclim_seas <- apply(clim_anomaly, c(1,2,3), sum)
  anoref_seas <- apply(obs_anomaly, c(1,2), sum)
  
    # MSESS
    
  msess <- veriApply("EnsMsess", fcst=t(prev_seas_mean), fcst.ref=t(clim_seas_mean), obs=t(ref_seas), parallel = TRUE)

    # ACC #
    
      # Pearson for continued indicators
        #if (ind!=3 & ind!=4 & ind!=5) { 
      # ref vs prev
    acc_prev <- veriApply("EnsCorr", fcst=anoprev_seas, obs=anoref_seas)
      # ref vs clim
    acc_clim <- veriApply("EnsCorr", fcst=anoclim_seas, obs=anoref_seas)
    
    #     } else { # Spearman for ordinal indicators
    #       Spearman <- s2dverification:::.Corr
    #   # ref vs prev
    # acc_prev <- veriApply("Corr", fcst=anoprev_seas, obs=anoref_seas, parallel = TRUE)$corr
    #   # ref vs clim
    # acc_clim <- veriApply("Corr", fcst=anoclim_seas, obs=anoref_seas, parallel = TRUE)$corr
    #    
    # }
    
  det_seas <- array(c(msess, acc_prev, acc_clim), dim=c(ngrids,3))
  
  nom_prevmonth <- paste0(indic[ind], b,"scoredetmonth_grid_prev.RData")
  nom_prevseas <- paste0(indic[ind], b,"scoredetseas_grid_prev.RData")

  save(det_month, file = file.path(dir_data, "score", nom_prevmonth))
  save(det_seas, file = file.path(dir_data, "score", nom_prevseas))

  #gc(TRUE)

}
stopCluster(cl)

}
tictoc::toc() 

```


