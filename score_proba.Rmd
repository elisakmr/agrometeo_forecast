---
title: "score_proba"
output: html_document
67.26 sec elapsed
---

```{r setup, include=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/season_trial2" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure"
library(easyVerification)
library(verification)
library(dplyr)
library(stats)
library(SpecsVerification)
library(s2dverification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
no_core <- 5
e <- 4 # number of events : auc h/m/l tercile/quintile 

```

## Loading latitude file

To be used for weighted aggregation.

```{r }
load(file = file.path(dir_data, "extract", "lat.RData"))
lati <- as.vector(vect_lat)

```


## Box-agregated scores

Aggregation computed using latitude weighting

```{r}
cl <- makeCluster(no_core)
registerDoParallel(cl)
tictoc::tic()
foreach(b=1:1000, .export = 'score_boite_prob') %dopar%  { # loop on bootstrap samples
  for (ind in 1:8){

  nom_ref <- paste0(indic[ind],b,"_bin_obs.RData")
  nom_prev <- paste0(indic[ind],b,"_prob_prev.RData")
 
  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))
  
  scor_ps <- list()
  for (t in 1: ndimT){
    int_ps <- list()
    for (e in 1:4){ #prev_prob, obs_bin, lati, nb_bin, e
      int_ps[[e]] <- score_boite_prob(prob_ps, bin_ref, t, lati[,1], nb_bin = 5, e)
      
    }
    scor_ps[[t]] <- int_ps
  }
  nom_ps <- paste0(indic[ind], b,"probbox_ps.RData")
  
  save(scor_ps, file = file.path(dir_data, "score", nom_ps))
}
}

stopCluster(cl)
tictoc::toc()

```


## Gridded scores

Scores computed for each grid separately

```{r}
cl <- makeCluster(no_core)
registerDoParallel(cl)
tictoc::tic()
foreach(b=1:100, .packages = 'easyVerification') %dopar%  { # loop on bootstrap samples

  for (ind in 1:2){

  nom_ref <- paste0(indic[ind],b,"_ref.RData")
  nom_prev <- paste0(indic[ind],b,"_prev.RData")

  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))

  nom_probps <- paste0(indic[ind],b,"_prob_prev.RData")
  nom_obsbin <- paste0(indic[ind],b,"_bin_obs.RData")

  load(file = file.path(dir_data, "extract", nom_probps))
  load(file = file.path(dir_data, "extract", nom_obsbin))
  
  scoreprob_ps <- array (NA, dim=c(ngrids,ndimT,e))

  for (t in 1:ndimT){

     scoreprob_ps[,t,1] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:2/3, parallel = TRUE)$cat1 
     scoreprob_ps[,t,2] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:2/3, parallel = TRUE)$cat3 
     scoreprob_ps[,t,3] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat1 
     scoreprob_ps[,t,4] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat5
  
  }
  nom_prev <- paste0(indic[ind], b,"scoreprob_grid_prev.RData")

  save(scoreprob_ps, file = file.path(dir_data, "score", nom_prev))

}
}

stopCluster(cl)
tictoc::toc()


```
