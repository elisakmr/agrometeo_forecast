---
title: "score_proba"
output: html_document
67.26 sec elapsed
---

```{r setup, include=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/season_trial2" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure"
library(easyVerification)
library(verification)
library(dplyr)
library(stats)
library(SpecsVerification)
library(s2dverification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
no_core <- 5
e <- 4 # number of events : auc h/l tercile/quintile 

```

## Loading latitude file

To be used for weighted aggregation.

```{r }
load(file = file.path(dir_data, "extract", "lat.RData"))
lati <- as.vector(vect_lat)

```


## Box-agregated scores

Aggregation computed using latitude weighting

```{r}
cl <- makeCluster(no_core)
registerDoParallel(cl)
tictoc::tic()
foreach(b=1:1000, .export = 'score_boite_prob') %dopar%  { # loop on bootstrap samples
  for (ind in 1:8){

  nom_ref <- paste0(indic[ind],b,"_bin_obs.RData")
  nom_prev <- paste0(indic[ind],b,"_prob_prev.RData")
  nom_clim <- paste0(indic[ind],b,"_prob_clim.RData")
 
  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))
  load(file = file.path(dir_data, "extract", nom_clim))
  
  scor_ps <- list()
  scor_clim <- list()
  for (t in 1: ndimT){
    int_ps <- list()
    int_clim <- list()
    for (e in 1:4){ #prev_prob, obs_bin, lati, nb_bin, e
      int_ps[[e]] <- score_boite_prob(prob_ps, bin_ref, t, lati[,1], nb_bin = 5, e)
      int_clim[[e]] <- score_boite_prob(prob_clim, bin_ref, t, lati[,1], nb_bin = 5, e)
      
    }
    scor_ps[[t]] <- int_ps
    scor_clim[[t]] <- int_clim
  }
  nom_ps <- paste0(indic[ind], b,"probbox_ps.RData")
  nom_clim <- paste0(indic[ind], b,"probbox_clim.RData")
  
  save(scor_ps, file = file.path(dir_data, "score", nom_ps))
  save(scor_clim, file = file.path(dir_data, "score", nom_clim))
}
}

stopCluster(cl)
tictoc::toc()

```


## Gridded scores

Scores computed for each grid separately

```{r}
cl <- makeCluster(no_core)
registerDoParallel(cl)
tictoc::tic()
foreach(b=1:1000, .packages = 'easyVerification') %dopar%  { # loop on bootstrap samples

  for (ind in 1:8){

  nom_ref <- paste0(indic[ind],b,"_ref.RData")
  nom_prev <- paste0(indic[ind],b,"_prev.RData")
  nom_clim <- paste0(indic[ind],b,"_clim.RData")
 
  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))
  load(file = file.path(dir_data, "extract", nom_clim))
  
  nom_probps <- paste0(indic[ind],b,"_prob_prev.RData")
  nom_climps <- paste0(indic[ind],b,"_prob_clim.RData")
  nom_obsbin <- paste0(indic[ind],b,"_bin_obs.RData")

  load(file = file.path(dir_data, "extract", nom_probps))
  load(file = file.path(dir_data, "extract", nom_climps))
  load(file = file.path(dir_data, "extract", nom_obsbin))
  
  scoreprob_ps <- array (NA, dim=c(ngrids,ndimT,e))
  scoreprob_clim <- array (NA, dim=c(ngrids,ndimT,e))
  
  for (t in 1:ndimT){
    # PREVISION
 
    # scoreprob_ps[i,t,1] <- roc.area(bin_ref[i,,t,1], prob_ps[i,,t,1])$A
    # scoreprob_ps[i,t,2] <- roc.area(bin_ref[i,,t,2], prob_ps[i,,t,2])$A
    # scoreprob_ps[i,t,3] <- roc.area(bin_ref[i,,t,3], prob_ps[i,,t,3])$A
    # scoreprob_ps[i,t,4] <- roc.area(bin_ref[i,,t,4], prob_ps[i,,t,4])$A
    # 
     #EnsRoca(prob_ps[,,t,3], bin_ref[,,t,3])
     scoreprob_ps[,t,1] <- veriApply("EnsRoca", fcst=array_prev[55,,,3], obs=array_obs[55,,3], prob=1:2/3, na.rm = TRUE)$cat3 
     scoreprob_ps[,t,2] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:2/3, parallel = TRUE)$cat1 
     scoreprob_ps[,t,3] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat5 
     scoreprob_ps[,t,4] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat1 
    #veriApply("EnsRoca", fcst=array_prev[19,,,t], obs=array_obs[19,,t], prob=1:4/5, parallel = TRUE)$cat5
      # CLIMATO
     scoreprob_clim[,t,1] <- veriApply("EnsRoca", fcst=array_clim[55,,,3], obs=array_obs[55,,3], prob=1:2/3, parallel = TRUE)$cat3 
     scoreprob_clim[,t,2] <- veriApply("EnsRoca", fcst=array_clim[,,,t], obs=array_obs[,,t], prob=1:2/3, parallel = TRUE)$cat1 
     scoreprob_clim[,t,3] <- veriApply("EnsRoca", fcst=array_clim[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat5 
     scoreprob_clim[,t,4] <- veriApply("EnsRoca", fcst=array_clim[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat1 
     # 
    
  }
  nom_prev <- paste0(indic[ind], b,"scoreprob_grid_prev.RData")
  nom_clim <- paste0(indic[ind], b,"scoreprob_grid_clim.RData")
  
  save(scoreprob_ps, file = file.path(dir_data, "score", nom_prev))
  save(scoreprob_clim, file = file.path(dir_data, "score", nom_clim))
  
}
}

stopCluster(cl)
tictoc::toc()


```
