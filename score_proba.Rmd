---
title: "score_proba"
output: html_document
67.26 sec elapsed
---

```{r setup, include=FALSE}
dir_data <- "D:/HOME/ekamir/scoring_medscope/data/season_trial2" 
dir_plot <- "D:/HOME/ekamir/scoring_medscope/figure"
library(easyVerification)
library(verification)
library(dplyr)
library(stats)
library(SpecsVerification)
library(s2dverification)
library(foreach)
library(iterators)
library(parallel)
library(doParallel)
no_core <- 5
e<-4
```

## Loading latitude file

To be used for weighted aggregation.

```{r }
load(file = file.path(dir_data, "extract", "lat.RData"))
lati <- as.vector(vect_lat)

```


## Box-agregated scores

Aggregation computed using latitude weighting

```{r}
tictoc::tic()

for (ind in 1:8){
  # monthly
  scor_mont <- list()
  for (t in 1: ndimT){
    list_event <- list()
    for (e in 1:6){ #LT,MT,HT//LQ,MQ,HQ
      vect_boot <- vector()
      for(b in 1:1000){

      nom_ref <- paste0(indic[ind],b,"_bin_obs.RData")
      nom_prev <- paste0(indic[ind],b,"_prob_prev.RData")
     
      load(file = file.path(dir_data, "extract", nom_ref))
      load(file = file.path(dir_data, "extract", nom_prev))
    
      vect_boot[[b]] <- score_boite_prob(prob_ps, bin_ref, t, lati[,1], nb_bin = 5, e)$AUC
      }
      
    list_event[[e]] <- vect_boot
    }
    
  scor_mont[[t]] <- list_event
  }
  
  nom_ps <- paste0(indic[ind],"scorprob_box.RData")
  save(scor_mont, file = file.path(dir_data, "score", nom_ps))

  # seasonal 
  score_event <- list()
  for (e in 1:3){ #LT,MT,HT//LQ,MQ,HQ
      vect_boot <- vector()
      for(b in 1:500){

      nom_prevseas <- paste0(indic[ind],b,"_seasprob_prev.RData")
      nom_refseas <- paste0(indic[ind],b,"_seasbin_obs.RData")
      load(file = file.path(dir_data, "extract", nom_prevseas))
      load(file = file.path(dir_data, "extract", nom_refseas))
    
      vect_boot[[b]] <- score_boite_prob(prob_ps, bin_ref, lati[,1], nb_bin = 5, e)$AUC
      }
      
    score_event[[e]] <- vect_boot
 }
  
  nom_ps <- paste0(indic[ind],"seasprobscor_box.RData")
  save(scor_mont, file = file.path(dir_data, "score", nom_ps))

}

tictoc::toc()

```
## Box-agregated score analysis

Transform lists in a more handy format

```{r}

for (ind in 1:8){
  nom_ps <- paste0(indic[ind],"scorprob_box.RData")
  load(file = file.path(dir_data, "score", nom_ps))

  sum_df <- matrix(ncol = ndimT, nrow = 6)
  
  for (t in 1: ndimT){
    for (e in 1:6){ #LT,MT,HT//LQ,MQ,HQ
    sum_df[t,e] <- mean(scor_mont[[t]][[e]])

    }
  }
  
  colnames(sum_df) <- c("LT","MT","HT","LQ","MQ","HQ")
  nom_ps <- paste0(indic[ind],"scorprob_boxav.csv")
  write_csv(as.data.frame(sum_df), file.path(dir_data, "score", nom_ps))
}

nom_ps <- paste0(indic[ind],"scorprob_boxav.csv")
load(file = file.path(dir_data, "score", nom_ps))

```


## Gridded scores

Scores computed for each grid separately.
Continuous indicators are assessed monthly while discrete indicators are assessed on whole aggregated season = 6 months (monthly summaries are summed up). 

```{r}
tictoc::tic()
e <- 2
for (ind in 2:8){
  cl <- makeCluster(no_core)
  registerDoParallel(cl)

foreach(b=1:500, .packages = 'easyVerification') %dopar%  { # loop on bootstrap samples

  #nom_prevseas <- paste0(indic[ind],b,"_seasprob_prev.RData")
  #nom_refseas <- paste0(indic[ind],b,"_seasbin_obs.RData")
  nom_ref <- paste0(indic[ind],b,"_ref.RData")
  nom_prev <- paste0(indic[ind],b,"_prev.RData")

  # load(file = file.path(dir_data, "extract", nom_prevseas))
  # load(file = file.path(dir_data, "extract", nom_refseas))
  load(file = file.path(dir_data, "extract", nom_ref))
  load(file = file.path(dir_data, "extract", nom_prev))
 
 # if (ind!=3 & ind!=4 & ind!=5) { 
    # nom_prevmonth <- paste0(indic[ind],b,"_monthprob_prev.RData")
    # nom_refmonth <- paste0(indic[ind],b,"_monthbin_obs.RData")
    # 
    # load(file = file.path(dir_data, "extract", nom_prevmonth))
    # load(file = file.path(dir_data, "extract", nom_refmonth))
 # }

  # only continuous indicators assessed monthly
    scoreprob_month_ps <- array (NA, dim=c(ngrids,ndimT,e))
    scoreprob_seas_ps <- array (NA, dim=c(ngrids,e))
    # monthly
    if (ind!=3 & ind!=4 & ind!=5) { 
       for (t in 1:ndimT){
        scoreprob_month_ps[,t,1] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:2/3, parallel = TRUE)$cat1 
        scoreprob_month_ps[,t,2] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:2/3, parallel = TRUE)$cat3 
        #scoreprob_month_ps[,t,3] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat1 
        #scoreprob_month_ps[,t,4] <- veriApply("EnsRoca", fcst=array_prev[,,,t], obs=array_obs[,,t], prob=1:4/5, parallel = TRUE)$cat5
       }
    }
    
    # seasonal
    seas_obs <- apply(array_obs[,,],c(1,2), sum)
    seas_prev <- apply(array_prev[,,,],c(1,2,3), sum)
    scoreprob_seas_ps[,1] <- veriApply("EnsRoca", fcst=seas_prev, obs=seas_obs, prob=1:2/3, parallel = TRUE)$cat1 
    scoreprob_seas_ps[,2] <- veriApply("EnsRoca", fcst=seas_prev, obs=seas_obs, prob=1:2/3, parallel = TRUE)$cat3 
   
     # for (i in 1:ngrids){
    #   
    #   # monthly scoring for continuous indicators only
    #   if (ind!=3 & ind!=4 & ind!=5) { 
    #   for (t in 1:ndimT){
    #      scoreprob_month_ps[i,t,1] <- roc.area(monthbin_ref[i,,t,1],monthprob_ps[i,,t,1])$A
    #      scoreprob_month_ps[i,t,2] <- roc.area(monthbin_ref[i,,t,3],monthprob_ps[i,,t,3])$A
    #      scoreprob_month_ps[i,t,3] <- roc.area(monthbin_ref[i,,t,4],monthprob_ps[i,,t,4])$A
    #      scoreprob_month_ps[i,t,4] <- roc.area(monthbin_ref[i,,t,6],monthprob_ps[i,,t,6])$A
    #   }
    #   }
    #   
    #   scoreprob_seas_ps[i,1] <- roc.area(seasbin_ref[i,,1],seasprob_ps[i,,1])$A
    #   scoreprob_seas_ps[i,2] <- roc.area(seasbin_ref[i,,3],seasprob_ps[i,,3])$A
    #   scoreprob_seas_ps[i,3] <- roc.area(seasbin_ref[i,,4],seasprob_ps[i,,4])$A
    #   scoreprob_seas_ps[i,4] <- roc.area(seasbin_ref[i,,6],seasprob_ps[i,,6])$A
    # }
  
    nom_prevmont <- paste0(indic[ind], b,"scoreprobmonth_grid_prev.RData")
    nom_prevseas <- paste0(indic[ind], b,"scoreprobseason_grid_prev.RData")

    save(scoreprob_month_ps, file = file.path(dir_data, "score", nom_prevmont))
    save(scoreprob_seas_ps, file = file.path(dir_data, "score", nom_prevseas))

  }
  
  # all other indicators assessed on whole season
  # scoreprob_ps <- array (NA, dim=c(ngrids,e))
  # prev_seas <- apply(array_prev[,,,], c(1,2,3), sum)
  # obs_seas <- apply(array_obs[,,], c(1,2), sum)
  #   
  # scoreprob_ps[,1] <- veriApply("EnsRoca", fcst=prev_seas, obs=obs_seas, prob=1:2/3, parallel = TRUE)$cat1 
  # scoreprob_ps[,2] <- veriApply("EnsRoca", fcst=prev_seas, obs=obs_seas, prob=1:2/3, parallel = TRUE)$cat3 
  # scoreprob_ps[,3] <- veriApply("EnsRoca", fcst=prev_seas, obs=obs_seas, prob=1:4/5, parallel = TRUE)$cat1 
  # scoreprob_ps[,4] <- veriApply("EnsRoca", fcst=prev_seas, obs=obs_seas, prob=1:4/5, parallel = TRUE)$cat5
  #  
  # nom_prev <- paste0(indic[ind], b,"scoreprobseason_grid_prev.RData")
  # 
  # save(scoreprob_ps, file = file.path(dir_data, "score", nom_prev))

stopCluster(cl)
}

tictoc::toc()



```



